# review_report_url:https://harfanglab.io/insidethelab/compromised-routers-infrastructure-target-europe-caucasus/
# review_date: 2024-10-26
# review_author: Blackpearl
# review_rule_useful: true
# review_rule_classification: proceed to testing
# review_rule_classification_reason: na
# review_rule_ttp_match: yes
# review_notes:
#  - The detection rule for MASEPIE malware you created is well-aligned with the CTI report from HarfangLab. The report outlines the behavior of MASEPIE, including its use of specific commands and error messages, which are captured in your detection criteria. Additionally, the rule targets the file size range consistent with MASEPIE's operation, confirming its relevance in detecting potential malicious activity.

title: Detection of MASEPIE Malware
id: af42c356-b274-45c3-8548-2d6e206fcf19
status: experimental
description: Detects specific strings indicative of MASEPIE malware behavior, such as error messages and random string generation, within a certain file size range.
references:
  - https://harfanglab.io/insidethelab/compromised-routers-infrastructure-target-europe-caucasus
author: System Two Security
date: 2024/10/25
tags:
  - attack.t1059
  - attack.execution
logsource:
  product: windows
  category: file_event
detection:
  selection:
    TargetFilename|endswith:
      - .bat
      - .html
      - .exe
      - .vbs
      - .js
      - .php
      - .ps1
    Image|contains|all:
      - cmd.exe
      - powershell.exe
    CommandLine|contains:
      - '{user}{SEPARATOR}{k}'
      - .join(random.SystemRandom().choice(string.ascii_letters + string.digits) for _ in range(16))
      - os.popen('whoami').read()
      - check-ok
      - dec_file_mes(mes, key)
      - Try it againg
      - Error transporting file
  condition: selection
falsepositives:
  - Legitimate applications that use similar strings or command-line arguments
  - Development tools or scripts that generate random strings or handle errors in a similar fashion
level: high
